<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Recent Predictions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.bootstrap5.min.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: var(--bs-body-bg);
    }
    h2 {
      font-weight: bold;
      color: var(--bs-primary);
    }
    #themeToggle {
      cursor: pointer;
      transition: transform 0.2s;
    }
    #themeToggle:hover {
      transform: rotate(20deg);
    }
    .dt-buttons {
      margin-bottom: 1rem;
    }
    table.dataTable thead th {
      position: sticky;
      top: 0;
      background-color: #343a40;
      color: white;
    }
    .filter-row input {
      width: 100%;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container mt-5 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-clock-history"></i> Recent Predictions</h2>
      <i id="themeToggle" class="bi bi-brightness-high fs-4" title="Toggle Dark Mode"></i>
    </div>

    {% if records %}
      <div class="table-responsive">
        <table id="predictionsTable" class="table table-striped table-bordered table-hover w-100">
          <thead class="table-dark">
            <tr>
              {% for key in records[0].keys() %}
                <th>{{ key.replace('_', ' ') }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for record in records %}
              <tr>
                {% for value in record.values() %}
                  <td>{{ value }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info text-center">
        <i class="bi bi-info-circle"></i> No predictions available.
      </div>
    {% endif %}

    <div class="text-center mt-4">
      <a href="/" class="btn btn-primary btn-lg">
        <i class="bi bi-arrow-left-circle"></i> Back to Prediction
      </a>
    </div>

    <div class="text-center mt-3">
      <button class="btn btn-info btn-lg" data-bs-toggle="modal" data-bs-target="#chartsModal">
        <i class="bi bi-bar-chart-line-fill"></i> Visualise data on  Graphs
      </button>
    </div>
  </div>

  <!-- Modal for Charts -->
  <div class="modal fade" id="chartsModal" tabindex="-1" aria-labelledby="chartsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="chartsModalLabel"><i class="bi bi-graph-up"></i> Prediction Summary Charts</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <canvas id="barChart"></canvas>
            </div>
            <div class="col-md-6">
              <canvas id="pieChart"></canvas>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const html = document.documentElement;
      const toggle = document.getElementById("themeToggle");

      // Theme toggle
      const storedTheme = localStorage.getItem("theme");
      if (storedTheme) {
        html.setAttribute("data-bs-theme", storedTheme);
        toggle.className = storedTheme === "dark" ? "bi bi-moon-stars fs-4" : "bi bi-brightness-high fs-4";
      }

      toggle.addEventListener("click", () => {
        const current = html.getAttribute("data-bs-theme");
        const next = current === "dark" ? "light" : "dark";
        html.setAttribute("data-bs-theme", next);
        localStorage.setItem("theme", next);
        toggle.className = next === "dark" ? "bi bi-moon-stars fs-4" : "bi bi-brightness-high fs-4";
      });

      // Initialize DataTable
      const table = $('#predictionsTable').DataTable({
        dom: '<"d-flex justify-content-between align-items-center mb-3"Bf>rt<"mt-3 d-flex justify-content-between"lip>',
        buttons: [
          {
            extend: 'excelHtml5',
            title: 'Recent Predictions',
            className: 'btn btn-success'
          },
          {
            extend: 'colvis',
            className: 'btn btn-secondary'
          }
        ],
        paging: true,
        pageLength: 10,
        responsive: true,
        fixedHeader: true,
        initComplete: function () {
          const api = this.api();
          api.columns().every(function () {
            const column = this;
            $('input', column.header().nextElementSibling).on('keyup change clear', function () {
              column.search(this.value).draw();
            });
          });
        }
      });

      // Chart.js charts on modal open
      let barChart, pieChart;
      document.getElementById('chartsModal').addEventListener('shown.bs.modal', () => {
        const data = table.rows({ search: 'applied' }).data();
        const categoryCounts = {};
        const categoryIndex = 1; // Adjust this index to match the column you want to chart

        for (let i = 0; i < data.length; i++) {
          const value = data[i][categoryIndex];
          categoryCounts[value] = (categoryCounts[value] || 0) + 1;
        }

        const labels = Object.keys(categoryCounts);
        const values = Object.values(categoryCounts);

        if (barChart) barChart.destroy();
        if (pieChart) pieChart.destroy();

        barChart = new Chart(document.getElementById('barChart'), {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Count by Category',
              data: values,
              backgroundColor: 'rgba(54, 162, 235, 0.7)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: 'Bar Chart Summary' }
            }
          }
        });

        pieChart = new Chart(document.getElementById('pieChart'), {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              label: 'Distribution',
              data: values,
              backgroundColor: labels.map(() => `hsl(${Math.random() * 360}, 70%, 60%)`)
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'Pie Chart Summary' }
            }
          }
        });
      });
    });
  </script>
</body>
</html>
